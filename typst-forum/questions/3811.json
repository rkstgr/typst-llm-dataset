{
  "topic_metadata": {
    "id": 3811,
    "title": "Why does a line break inside math mode result in superscripts appearing at the wrong height?",
    "slug": "why-does-a-line-break-inside-math-mode-result-in-superscripts-appearing-at-the-wrong-height",
    "posts_count": 5,
    "created_at": "2025-04-25T18:00:22.778Z",
    "last_posted_at": "2025-04-29T03:57:40.008Z",
    "views": 98,
    "like_count": 4,
    "reply_count": 0,
    "has_accepted_answer": true,
    "accepted_answer_post_number": 2,
    "accepted_answer_username": "Andrew",
    "tags": [
      "math"
    ],
    "category_id": 5,
    "participant_count": 5,
    "word_count": 441
  },
  "posts": [
    {
      "id": 11615,
      "post_number": 1,
      "username": "Danil",
      "name": "Danil",
      "created_at": "2025-04-25T18:00:22.960Z",
      "updated_at": "2025-04-26T20:28:21.973Z",
      "cooked": "<p>Hi everyone,</p>\n<p>I’ve encountered a strange behavior when typesetting long math expressions in Typst, particularly when the line breaks across operators. It seems that when I break a line inside a math expression, superscripts (and subscripts too) don’t render properly.</p>\n<p>Here’s a minimal example:</p>\n<pre><code class=\"lang-auto\">$\ny = (a x^2 + \\\n+ b x + c)^2\n$\n</code></pre>\n<p>and this is what I get:<br>\n<img src=\"https://forum.typst.app/uploads/default/original/2X/4/4cc35cb3f1b81dd28ec2c357c9509116c8e65d48.png\" alt=\"typst_example\" data-base62-sha1=\"aX4QEcmXwnPHvCjrFBzWm7bje5y\" width=\"405\" height=\"201\"></p>\n<p>Is this expected behavior? Or am I missing a better way to break long equations over multiple lines while preserving correct math formatting?</p>\n<p>Thanks in advance!</p>",
      "raw": "Hi everyone,\n\nI’ve encountered a strange behavior when typesetting long math expressions in Typst, particularly when the line breaks across operators. It seems that when I break a line inside a math expression, superscripts (and subscripts too) don’t render properly.\n\nHere’s a minimal example:\n\n```typ... \n$\ny = (a x^2 + \\\n+ b x + c)^2\n$\n```\n and this is what I get: \n![typst_example|405x201](upload://aX4QEcmXwnPHvCjrFBzWm7bje5y.png)\n\nIs this expected behavior? Or am I missing a better way to break long equations over multiple lines while preserving correct math formatting?\n\nThanks in advance!",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 0,
      "reads": 26,
      "score": 80.2,
      "accepted_answer": false,
      "trust_level": 0,
      "user_id": 1511
    },
    {
      "id": 11618,
      "post_number": 2,
      "username": "Andrew",
      "name": "",
      "created_at": "2025-04-26T10:38:27.794Z",
      "updated_at": "2025-04-26T12:04:12.576Z",
      "cooked": "<p>Hello, there. You provided screenshot from different code, there is no plus sign to the left of the <code>b</code>. And with cutting like this, it changes from addition to signed value:</p>\n<p><img src=\"https://forum.typst.app/uploads/default/original/2X/2/268a928ee18f985d9bbc21cd1c7b5f8d09961997.png\" alt=\"image\" data-base62-sha1=\"5uX26YEe2NFKwD8p43MndjBCsrt\" width=\"133\" height=\"76\"></p>\n<p>You need to add <code>med</code> or something to make it readable.</p>\n<p>Looks like <a href=\"https://typst.app/docs/reference/math/lr#functions-lr\"><code>lr</code></a> creates a new scope. I don’t know how practical it is to break a parenthesized expression, but you can cancel the automatic sizing:</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">$\n  y = \\(a x^2 + \\\n  + b x + c)^2\n$\n</code></pre>\n<p><img src=\"https://forum.typst.app/uploads/default/original/2X/a/a415165b7650d7011a12f9bb382aa85f684ce7cc.png\" alt=\"image\" data-base62-sha1=\"npxu2DmVf20rj1pPjLqS3CUXDas\" width=\"117\" height=\"74\"></p>\n<p>If you need it back, then you would probably have to recreate it manually:</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">#let big(p) = $lr(size: #200%, #p)$\n\n$\n  y = big(\\()1 / a x^2 + \\\n  + med b x + c big(\\))^2\n$\n\n$\n  y = \\(1 / a x^2 + \\\n  + med b x + c \\)^2\n$\n\n$\n  y = (1 / a x^2 + b x + c)^2\n$\n</code></pre>\n<p><img src=\"https://forum.typst.app/uploads/default/original/2X/3/35d72258cb79209798db30ee70cbc5231ac7281c.png\" alt=\"image\" data-base62-sha1=\"7GiebmjNJu0Rtx2nP4f9GOWkEUI\" width=\"186\" height=\"265\"></p>\n<hr>\n<aside class=\"quote no-group quote-modified\" data-username=\"reknih\" data-post=\"1\" data-topic=\"11\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/user_avatar/forum.typst.app/reknih/48/3_2.png\" class=\"avatar\"><a href=\"https://forum.typst.app/t/how-to-post-in-the-questions-category/11/1\">How to post in the Questions category</a></div>\n<blockquote>\n<p>If your question pertains to a bit of Typst markup you have problems with, put it in the question body! You can syntax-highlight Typst code by wrapping it in ` ```typ … ````. It will then look like this:</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">#set font(size: 12pt)\n\nHello from *Typst* at $ pi.var + 1 $ o'clock!\n</code></pre>\n<p>If you need to highlight a code or math mode snippet instead, the language tags <code>typc</code> and <code>typm</code> do that, respectively.</p>\n</blockquote>\n</aside>",
      "raw": "Hello, there. You provided screenshot from different code, there is no plus sign to the left of the `b`. And with cutting like this, it changes from addition to signed value:\n\n![image|133x76](upload://5uX26YEe2NFKwD8p43MndjBCsrt.png)\n\nYou need to add `med` or something to make it readable.\n\nLooks like [`lr`](https://typst.app/docs/reference/math/lr#functions-lr) creates a new scope. I don't know how practical it is to break a parenthesized expression, but you can cancel the automatic sizing:\n\n```typ\n$\n  y = \\(a x^2 + \\\n  + b x + c)^2\n$\n```\n\n![image|117x74](upload://npxu2DmVf20rj1pPjLqS3CUXDas.png)\n\nIf you need it back, then you would probably have to recreate it manually:\n\n```typ\n#let big(p) = $lr(size: #200%, #p)$\n\n$\n  y = big(\\()1 / a x^2 + \\\n  + med b x + c big(\\))^2\n$\n\n$\n  y = \\(1 / a x^2 + \\\n  + med b x + c \\)^2\n$\n\n$\n  y = (1 / a x^2 + b x + c)^2\n$\n```\n\n![image|186x265](upload://7GiebmjNJu0Rtx2nP4f9GOWkEUI.png)\n\n---\n\n[quote=\"reknih, post:1, topic:11\"]\nIf your question pertains to a bit of Typst markup you have problems with, put it in the question body! You can syntax-highlight Typst code by wrapping it in ` ```typ ... ````. It will then look like this:\n\n```typ\n#set font(size: 12pt)\n\nHello from *Typst* at $ pi.var + 1 $ o'clock!\n```\n\nIf you need to highlight a code or math mode snippet instead, the language tags `typc` and `typm` do that, respectively.\n[/quote]",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 1,
      "reads": 24,
      "score": 19.8,
      "accepted_answer": true,
      "trust_level": 3,
      "user_id": 51
    },
    {
      "id": 11619,
      "post_number": 3,
      "username": "bluss",
      "name": "Ulrik",
      "created_at": "2025-04-26T11:03:06.491Z",
      "updated_at": "2025-04-26T11:03:06.491Z",
      "cooked": "<p>This problem sounds like something that should be reported as a bug, so that it can be discussed if it’s a bug to be fixed or not.</p>",
      "raw": "This problem sounds like something that should be reported as a bug, so that it can be discussed if it's a bug to be fixed or not.",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 1,
      "reads": 24,
      "score": 19.8,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 1272
    },
    {
      "id": 11620,
      "post_number": 4,
      "username": "Eric",
      "name": "Eric Biedert",
      "created_at": "2025-04-26T12:43:51.407Z",
      "updated_at": "2025-04-26T12:43:51.407Z",
      "cooked": "<p>This issue has been known for a while, you can follow it on GitHub for any updates:</p>\n<aside class=\"onebox githubissue\" data-onebox-src=\"https://github.com/typst/typst/issues/3704\">\n  <header class=\"source\">\n\n      <a href=\"https://github.com/typst/typst/issues/3704\" target=\"_blank\" rel=\"noopener nofollow ugc\">github.com/typst/typst</a>\n  </header>\n\n  <article class=\"onebox-body\">\n    <div class=\"github-row\">\n  <div class=\"github-icon-container\" title=\"Issue\" data-github-private-repo=\"false\">\n\t  <svg width=\"60\" height=\"60\" class=\"github-icon\" viewBox=\"0 0 14 16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg>\n  </div>\n\n  <div class=\"github-info-container\">\n    <h4>\n      <a href=\"https://github.com/typst/typst/issues/3704\" target=\"_blank\" rel=\"noopener nofollow ugc\">Misplaced exponents in multi-line math environment</a>\n    </h4>\n\n    <div class=\"github-info\">\n      <div class=\"date\">\n        opened <span class=\"discourse-local-date\" data-format=\"ll\" data-date=\"2024-03-17\" data-time=\"09:59:51\" data-timezone=\"UTC\">09:59AM - 17 Mar 24 UTC</span>\n      </div>\n\n\n      <div class=\"user\">\n        <a href=\"https://github.com/ralphmb\" target=\"_blank\" rel=\"noopener nofollow ugc\">\n          <img alt=\"ralphmb\" src=\"https://forum.typst.app/uploads/default/original/2X/5/533e13620d5f1446e0e4fcadf45ca5aae4a3542a.png\" class=\"onebox-avatar-inline\" width=\"20\" height=\"20\" data-dominant-color=\"CDD5EA\">\n          ralphmb\n        </a>\n      </div>\n    </div>\n\n    <div class=\"labels\">\n        <span style=\"display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;\">\n          bug\n        </span>\n        <span style=\"display:inline-block;margin-top:2px;background-color: #B8B8B8;padding: 2px;border-radius: 4px;color: #fff;margin-left: 3px;\">\n          math\n        </span>\n    </div>\n  </div>\n</div>\n\n  <div class=\"github-row\">\n    <p class=\"github-body-container\">### Description\n\nUsing Typst 0.11.0 but first found this behaviour in 0.10.0\n<span class=\"show-more-container\"><a href=\"\" rel=\"noopener\" class=\"show-more\">…</a></span><span class=\"excerpt hidden\">\nExponents placed after a multi-line aligned expression in a math block appear at the end of the first line, rather than after the expression ends on the bottom line.\nMinimal working example:\n```typst\n#lorem(20)\n$ (&amp;x \\\n   &amp;+y)^(2) = 1 $\n#lorem(20)\n```\nCalling `typst compile main.typ` on the previous code leads to the following being rendered:\n![Screenshot 2024-03-17 at 09 38 23](https://github.com/typst/typst/assets/18724395/21e772c5-0660-46bf-9377-e83d3b955049)\nThe exponent 2 should, I think, be placed after \"+y)\" on the second line. I ran into this first on a much more complex expression but it appears to happen for many different examples.\nAdding/removing parentheses around the exponent 2 doesn't change the output.\n\nPlacing an ampersand before the exponent, like `&amp;+y)&amp;^(2) = 1 $`,  seems to place the two correctly. This seems to be an easy workaround, but (imho) doesn't seem like an obvious thing to try. It was pointed out to me on [this reddit post](https://old.reddit.com/r/typst/comments/1bghapk/multiline_math_rendering_is_this_a_bug_i_should/).\nAdding the extra ampersand gives the following:\n![Screenshot 2024-03-17 at 09 56 37](https://github.com/typst/typst/assets/18724395/0e0cf15e-29a9-4988-8963-f32ef875b89b).\n\nI couldn't see any similar issues raised here so apologies if this is a duplicate/mistake on my end. I don't have discord or I would have posted this there first. Apologies in advance if I don't respond too quickly, still have to finish my dissertation :)\n\n### Reproduction URL\n\n_No response_\n\n### Operating system\n\nmacOS\n\n### Typst version\n\n- [X] I am using the latest version of Typst</span></p>\n  </div>\n\n  </article>\n\n  <div class=\"onebox-metadata\">\n    \n    \n  </div>\n\n  <div style=\"clear: both\"></div>\n</aside>\n",
      "raw": "This issue has been known for a while, you can follow it on GitHub for any updates:\n\nhttps://github.com/typst/typst/issues/3704",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 1,
      "reads": 21,
      "score": 49.2,
      "accepted_answer": false,
      "trust_level": 2,
      "user_id": 88
    },
    {
      "id": 11762,
      "post_number": 5,
      "username": "ian",
      "name": "Ian",
      "created_at": "2025-04-29T03:57:40.008Z",
      "updated_at": "2025-04-29T03:57:40.008Z",
      "cooked": "<p><a href=\"https://github.com/typst/typst/issues/3704#issuecomment-2837374053\" rel=\"noopener nofollow ugc\">I added a comment</a> to the github issue, but this is definitely a bug in the math layout code. Want to echo that the general solution is to escape the parentheses with backslashes: <code>$ y = \\(a x^2 + \\ + b x + c\\)^2 $</code> which will avoid creating the LR element that causes the grouping behavior.</p>",
      "raw": "[I added a comment](https://github.com/typst/typst/issues/3704#issuecomment-2837374053) to the github issue, but this is definitely a bug in the math layout code. Want to echo that the general solution is to escape the parentheses with backslashes: `$ y = \\(a x^2 + \\ + b x + c\\)^2 $` which will avoid creating the LR element that causes the grouping behavior.",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 1,
      "reads": 18,
      "score": 18.6,
      "accepted_answer": false,
      "trust_level": 2,
      "user_id": 25
    }
  ],
  "scraped_at": "2025-06-10T09:48:40.536331"
}