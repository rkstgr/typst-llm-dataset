{
  "topic_metadata": {
    "id": 2313,
    "title": "Is there an equivalent of global variable ? Modifying a variable outside current scope and context",
    "slug": "is-there-an-equivalent-of-global-variable-modifying-a-variable-outside-current-scope-and-context",
    "posts_count": 8,
    "created_at": "2025-01-05T19:49:26.631Z",
    "last_posted_at": "2025-01-05T23:07:31.185Z",
    "views": 444,
    "like_count": 4,
    "reply_count": 7,
    "has_accepted_answer": true,
    "accepted_answer_post_number": 4,
    "accepted_answer_username": "Mathemensch",
    "tags": [
      "scripting"
    ],
    "category_id": 5,
    "participant_count": 3,
    "word_count": 951
  },
  "posts": [
    {
      "id": 7222,
      "post_number": 1,
      "username": "Alex",
      "name": "Alex",
      "created_at": "2025-01-05T19:49:26.747Z",
      "updated_at": "2025-01-05T19:51:26.600Z",
      "cooked": "<p>Hello,<br>\nFor a personal project where i create a template for a student songbook  i want to maintain a global dictionary where at each song i “instantiate” i insert a new pair (title, page_number). For example :</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">#import utils:*\n\n#let song(title) = context {\n let pagenum = ...\nutils.my_dict_index.insert(title, page_num)\n}\n</code></pre>\n<p>I see two problems here :</p>\n<ul>\n<li>Modifying a variable outside of current function scope</li>\n<li>Modifying something outside of context.</li>\n</ul>\n<p>I’m not sure how to implement this (not even sure if it is possible). My first think goes to <code>#state()</code> function but i don’t really understand the whole principle of it.<br>\nSo is there a way to do this ?<br>\nThanks in advance for helping.</p>",
      "raw": "Hello,\nFor a personal project where i create a template for a student songbook  i want to maintain a global dictionary where at each song i \"instantiate\" i insert a new pair (title, page_number). For example : \n```typst\n#import utils:*\n\n#let song(title) = context {\n let pagenum = ...\nutils.my_dict_index.insert(title, page_num)\n}\n```\nI see two problems here : \n- Modifying a variable outside of current function scope\n- Modifying something outside of context.\n\nI'm not sure how to implement this (not even sure if it is possible). My first think goes to `#state()` function but i don't really understand the whole principle of it.\nSo is there a way to do this ?\nThanks in advance for helping.",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 0,
      "reads": 55,
      "score": 1811.0,
      "accepted_answer": false,
      "trust_level": 1,
      "user_id": 987
    },
    {
      "id": 7223,
      "post_number": 2,
      "username": "Mathemensch",
      "name": "Alexander Schulz",
      "created_at": "2025-01-05T20:12:52.418Z",
      "updated_at": "2025-01-05T20:14:08.746Z",
      "cooked": "<p>Hi Alex,</p>\n<p><code>#state</code> is definitely the right approach.<br>\nIt took me a little while to understand it too, to encourage you.</p>\n<p>Can you explain your workflow in more detail?<br>\nWhat exactly should be saved and when and how should it be called?<br>\nWhat is ‘page_number’? The page on which the current song is saved?</p>\n<p>If you explain this to me, I can try to help you with the implementation.</p>\n<p>Kind regards<br>\nAlex (that’s my name too :D)</p>",
      "raw": "Hi Alex,\n\n`#state` is definitely the right approach.\nIt took me a little while to understand it too, to encourage you.\n\nCan you explain your workflow in more detail?\nWhat exactly should be saved and when and how should it be called?\nWhat is ‘page_number’? The page on which the current song is saved?\n\nIf you explain this to me, I can try to help you with the implementation.\n\nKind regards\nAlex (that's my name too :D)",
      "reply_to_post_number": null,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 1,
      "reads": 51,
      "score": 40.2,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 307
    },
    {
      "id": 7225,
      "post_number": 3,
      "username": "Alex",
      "name": "Alex",
      "created_at": "2025-01-05T20:23:17.834Z",
      "updated_at": "2025-01-05T20:23:17.834Z",
      "cooked": "<p>Here’s a link to my project for more insight :<br>\n<a href=\"https://typst.app/project/rxJdkxQZb6FrIuv59NVJxS\" class=\"onebox\" target=\"_blank\" rel=\"noopener\">https://typst.app/project/rxJdkxQZb6FrIuv59NVJxS</a></p>\n<p>So basically my project revolve around 3 principals files  :</p>\n<ul>\n<li>style.typ : define the style of each element that constitute a ‘song’</li>\n<li>format.typ : format a song based on parameters received, using style defined previoulsy. Here i define a context function called “chant” (song in french) that i can use throughout the project (files found in \"chant/*.typ).</li>\n<li>utils.typ : define a few function useful for the whole project</li>\n</ul>\n<p>Basically i want to create and empty dictionary in utils.typ that contain all page numbers and title of each song to later construct an index table. The page number is the number of the page on which the song is located (already defined in <code>chant()</code> ).<br>\nSo i am thinking to update this <code>utils.index_dictionnary</code> at the end of <code>chant()</code> function and use it later in the project</p>",
      "raw": "Here's a link to my project for more insight : \nhttps://typst.app/project/rxJdkxQZb6FrIuv59NVJxS\n\nSo basically my project revolve around 3 principals files  : \n- style.typ : define the style of each element that constitute a 'song'\n- format.typ : format a song based on parameters received, using style defined previoulsy. Here i define a context function called \"chant\" (song in french) that i can use throughout the project (files found in \"chant/*.typ).\n- utils.typ : define a few function useful for the whole project\n\n\nBasically i want to create and empty dictionary in utils.typ that contain all page numbers and title of each song to later construct an index table. The page number is the number of the page on which the song is located (already defined in `chant()` ). \nSo i am thinking to update this `utils.index_dictionnary` at the end of `chant()` function and use it later in the project",
      "reply_to_post_number": 2,
      "reply_count": 2,
      "quote_count": 0,
      "like_count": 0,
      "reads": 50,
      "score": 20.0,
      "accepted_answer": false,
      "trust_level": 1,
      "user_id": 987
    },
    {
      "id": 7227,
      "post_number": 4,
      "username": "Mathemensch",
      "name": "Alexander Schulz",
      "created_at": "2025-01-05T21:06:39.742Z",
      "updated_at": "2025-01-05T21:06:39.742Z",
      "cooked": "<p>Ahh I see,</p>\n<p>then you should use the <code>#outline</code> function.</p>\n<p>I added the following code to your <code>#chant</code> command:</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">#let chant(\n  title,\n...\n) = context{\n  hide(heading(title))\n</code></pre>\n<p>Then you can create a outline with:</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">#outline()\n</code></pre>\n<p>which results in the following result:<br>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://forum.typst.app/uploads/default/original/2X/6/6c307c145bcd453d5b9d5c0fe728049cb218bb69.png\" data-download-href=\"https://forum.typst.app/uploads/default/6c307c145bcd453d5b9d5c0fe728049cb218bb69\" title=\"image\"><img src=\"https://forum.typst.app/uploads/default/optimized/2X/6/6c307c145bcd453d5b9d5c0fe728049cb218bb69_2_355x500.png\" alt=\"image\" data-base62-sha1=\"fr5rzGLA4k4T0zKu1fTPcr0btxL\" width=\"355\" height=\"500\" srcset=\"https://forum.typst.app/uploads/default/optimized/2X/6/6c307c145bcd453d5b9d5c0fe728049cb218bb69_2_355x500.png, https://forum.typst.app/uploads/default/optimized/2X/6/6c307c145bcd453d5b9d5c0fe728049cb218bb69_2_532x750.png 1.5x, https://forum.typst.app/uploads/default/optimized/2X/6/6c307c145bcd453d5b9d5c0fe728049cb218bb69_2_710x1000.png 2x\" data-dominant-color=\"F8F8F8\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">986×1388 146 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>",
      "raw": "Ahh I see,\n\nthen you should use the `#outline` function.\n\nI added the following code to your `#chant` command:\n```typst\n#let chant(\n  title,\n...\n) = context{\n  hide(heading(title))\n```\n\nThen you can create a outline with:\n```typst\n#outline()\n```\nwhich results in the following result:\n![image|355x500](upload://fr5rzGLA4k4T0zKu1fTPcr0btxL.png)",
      "reply_to_post_number": 3,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 1,
      "reads": 50,
      "score": 105.0,
      "accepted_answer": true,
      "trust_level": 3,
      "user_id": 307
    },
    {
      "id": 7228,
      "post_number": 5,
      "username": "Alex",
      "name": "Alex",
      "created_at": "2025-01-05T21:11:07.037Z",
      "updated_at": "2025-01-05T21:11:07.037Z",
      "cooked": "<p>I’m trying to implement the solution like this :</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">//in utils.typ\n#let index_dict = state(\"index_dict\", (:))\n\n// in format.typ\n\n#let chant(...) = context{\n  let dict = utils.index_dict.get()\n  dict.insert(title,utils.get_page_number())\n  utils.index_dict.update(dict)\n}\n</code></pre>\n<p>I get a warning :<br>\nLayout did not converge within 5 attempts <small>(warning)</small></p>\n<p>Since my problem can be extrapolated  to others problem is it possible to explain why ?</p>",
      "raw": "I'm trying to implement the solution like this : \n```typst\n//in utils.typ\n#let index_dict = state(\"index_dict\", (:))\n\n// in format.typ\n\n#let chant(...) = context{\n  let dict = utils.index_dict.get()\n  dict.insert(title,utils.get_page_number())\n  utils.index_dict.update(dict)\n}\n```\n\nI get a warning : \nLayout did not converge within 5 attempts <small>(warning)</small>\n\nSince my problem can be extrapolated  to others problem is it possible to explain why ?",
      "reply_to_post_number": 3,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 0,
      "reads": 46,
      "score": 14.2,
      "accepted_answer": false,
      "trust_level": 1,
      "user_id": 987
    },
    {
      "id": 7229,
      "post_number": 6,
      "username": "Alex",
      "name": "Alex",
      "created_at": "2025-01-05T21:11:24.333Z",
      "updated_at": "2025-01-05T21:31:23.602Z",
      "cooked": "<p>It worked, but now i get a bunch of white pages appearing. I supposed it is due to the height of the heading took into account even though it is set to hidden. I will search to prevent this.</p>\n<p>edit : set the size of heading to 0pt</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">show heading: text.with(size: 0pt)\nhide(heading(title))\n</code></pre>\n<p>That said, is there a solution involving <code>#state()</code>? I think my problem could be generalized to something like: ‘How to use or modify a global variable effectively?’</p>",
      "raw": "It worked, but now i get a bunch of white pages appearing. I supposed it is due to the height of the heading took into account even though it is set to hidden. I will search to prevent this.\n\nedit : set the size of heading to 0pt\n```typst\nshow heading: text.with(size: 0pt)\nhide(heading(title))\n```\n\nThat said, is there a solution involving `#state()`? I think my problem could be generalized to something like: 'How to use or modify a global variable effectively?'",
      "reply_to_post_number": 4,
      "reply_count": 2,
      "quote_count": 0,
      "like_count": 0,
      "reads": 41,
      "score": 33.2,
      "accepted_answer": false,
      "trust_level": 1,
      "user_id": 987
    },
    {
      "id": 7231,
      "post_number": 8,
      "username": "Mathemensch",
      "name": "Alexander Schulz",
      "created_at": "2025-01-05T22:08:50.630Z",
      "updated_at": "2025-01-05T22:08:50.630Z",
      "cooked": "<p>This project seems very complex and large, making it difficult to quickly identify why the layout doesn’t converge. There could be many reasons for this, especially in a project of this scale.</p>\n<p>However, here’s a Minimal Working Example (MWE) that uses a global state to store songs and their page numbers, which might help you troubleshoot your issue:</p>\n<p><a href=\"https://typst.app/project/rNyGAAnyyagyfz1y2e3jdU\" class=\"onebox\" target=\"_blank\" rel=\"noopener\">https://typst.app/project/rNyGAAnyyagyfz1y2e3jdU</a></p>\n<p>This is the minimal <code>chants.typ</code> for storing and getting chant title and page number:</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">// chants.typ\n\n// State for the songs\n#let _state_chants = state(\"chants\", ())\n#let _page = counter(page)\n\n// Main function to add a song\n#let chant(title: \"\") = {\n  // Update state with new song\n  context {\n    let new_page = _page.get().first()\n    _state_chants.update(songs =&gt; {\n      songs.push((\n        title: title,\n        page: new_page,\n      ))\n      songs\n    })\n  }\n  // Show the title as heading\n  heading(level: 2, title)\n}\n\n// Function to create table of contents\n#let chant-outline() = {\n  heading(level: 1, \"Liedverzeichnis\")\n\n  context {\n    let songs = _state_chants.final()\n\n    for song in songs [\n      #song.title\n      #box(width: 1fr, repeat[.])\n      #song.page\n      #linebreak()\n    ]\n  }\n}\n</code></pre>\n<p>this is an example usage of this file:</p>\n<pre data-code-wrap=\"typst\"><code class=\"lang-typst\">//example.typ\n#import \"chants.typ\": *\n\n#set page(\n  \"a6\",\n  numbering: \"1\",\n)\n\n// Outline of the songs\n#chant-outline()\n\n#pagebreak()\n\n#chant(title: \"Amazing Grace\")\nLorem ipsum dolor sit amet...\n\n#pagebreak()\n\n#chant(title: \"Hallelujah\")\nConsectetur adipiscing elit...\n\n</code></pre>",
      "raw": "This project seems very complex and large, making it difficult to quickly identify why the layout doesn’t converge. There could be many reasons for this, especially in a project of this scale.\n\nHowever, here’s a Minimal Working Example (MWE) that uses a global state to store songs and their page numbers, which might help you troubleshoot your issue:\n\nhttps://typst.app/project/rNyGAAnyyagyfz1y2e3jdU\n\nThis is the minimal `chants.typ` for storing and getting chant title and page number:\n```typst\n// chants.typ\n\n// State for the songs\n#let _state_chants = state(\"chants\", ())\n#let _page = counter(page)\n\n// Main function to add a song\n#let chant(title: \"\") = {\n  // Update state with new song\n  context {\n    let new_page = _page.get().first()\n    _state_chants.update(songs => {\n      songs.push((\n        title: title,\n        page: new_page,\n      ))\n      songs\n    })\n  }\n  // Show the title as heading\n  heading(level: 2, title)\n}\n\n// Function to create table of contents\n#let chant-outline() = {\n  heading(level: 1, \"Liedverzeichnis\")\n\n  context {\n    let songs = _state_chants.final()\n\n    for song in songs [\n      #song.title\n      #box(width: 1fr, repeat[.])\n      #song.page\n      #linebreak()\n    ]\n  }\n}\n```\n\nthis is an example usage of this file:\n\n```typst\n//example.typ\n#import \"chants.typ\": *\n\n#set page(\n  \"a6\",\n  numbering: \"1\",\n)\n\n// Outline of the songs\n#chant-outline()\n\n#pagebreak()\n\n#chant(title: \"Amazing Grace\")\nLorem ipsum dolor sit amet...\n\n#pagebreak()\n\n#chant(title: \"Hallelujah\")\nConsectetur adipiscing elit...\n\n```",
      "reply_to_post_number": 6,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 1,
      "reads": 42,
      "score": 68.4,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 307
    },
    {
      "id": 7232,
      "post_number": 9,
      "username": "SillyFreak",
      "name": "SillyFreak",
      "created_at": "2025-01-05T23:07:31.185Z",
      "updated_at": "2025-01-05T23:07:31.185Z",
      "cooked": "<aside class=\"quote no-group\" data-username=\"Alex\" data-post=\"5\" data-topic=\"2313\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/user_avatar/forum.typst.app/alex/48/1696_2.png\" class=\"avatar\"> Alex:</div>\n<blockquote>\n<p>I’m trying to implement the solution like this :</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">//in utils.typ\n#let index_dict = state(\"index_dict\", (:))\n\n// in format.typ\n\n#let chant(...) = context{\n  let dict = utils.index_dict.get()\n  dict.insert(title,utils.get_page_number())\n  utils.index_dict.update(dict)\n}\n</code></pre>\n<p>I get a warning :<br>\nLayout did not converge within 5 attempts <small>(warning)</small></p>\n</blockquote>\n</aside>\n<p>In this case the cause is actually fairly clear: you use <code>get()</code> followed by <code>update()</code> instead of update with a callback. Here is a post where I explain in detail what the problem and fix for it is: <a href=\"https://forum.typst.app/t/why-is-state-final-not-final/1483/2\" class=\"inline-onebox\">Why is State Final not \"final\"? - #2 by SillyFreak</a></p>\n<aside class=\"quote no-group\" data-username=\"Alex\" data-post=\"6\" data-topic=\"2313\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/user_avatar/forum.typst.app/alex/48/1696_2.png\" class=\"avatar\"> Alex:</div>\n<blockquote>\n<p>I will search to prevent this.</p>\n<p>edit : set the size of heading to 0pt</p>\n<pre><code class=\"lang-auto\">show heading: text.with(size: 0pt)\nhide(heading(title))\n</code></pre>\n</blockquote>\n</aside>\n<p>a bit “cleaner” is I think using <code>place(hide(...))</code> which prevents the header from being considered for layout at all.</p>\n<p>But the state based solution Mathemensch shows (using <code>update(songs =&gt; ...)</code> looks good :) I don’t think it has convergence problems.The <code>update()</code> is inside a context and depends on a <code>get()</code> but I <em>think</em> it’s fine because it’s a different counter.</p>",
      "raw": "[quote=\"Alex, post:5, topic:2313\"]\nI’m trying to implement the solution like this :\n\n```typ\n//in utils.typ\n#let index_dict = state(\"index_dict\", (:))\n\n// in format.typ\n\n#let chant(...) = context{\n  let dict = utils.index_dict.get()\n  dict.insert(title,utils.get_page_number())\n  utils.index_dict.update(dict)\n}\n```\n\nI get a warning :\nLayout did not converge within 5 attempts <small>(warning)</small>\n[/quote]\n\nIn this case the cause is actually fairly clear: you use `get()` followed by `update()` instead of update with a callback. Here is a post where I explain in detail what the problem and fix for it is: https://forum.typst.app/t/why-is-state-final-not-final/1483/2?u=sillyfreak\n\n[quote=\"Alex, post:6, topic:2313\"]\nI will search to prevent this.\n\nedit : set the size of heading to 0pt\n\n```\nshow heading: text.with(size: 0pt)\nhide(heading(title))\n```\n[/quote]\n\na bit \"cleaner\" is I think using `place(hide(...))` which prevents the header from being considered for layout at all.\n\nBut the state based solution Mathemensch shows (using `update(songs => ...)` looks good :) I don't think it has convergence problems.The `update()` is inside a context and depends on a `get()` but I _think_ it's fine because it's a different counter.",
      "reply_to_post_number": 5,
      "reply_count": 0,
      "quote_count": 2,
      "like_count": 1,
      "reads": 34,
      "score": 46.8,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 32
    }
  ],
  "scraped_at": "2025-06-10T09:53:05.851141"
}