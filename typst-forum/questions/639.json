{
  "topic_metadata": {
    "id": 639,
    "title": "How can I get a box to use all height under a floating element?",
    "slug": "how-can-i-get-a-box-to-use-all-height-under-a-floating-element",
    "posts_count": 10,
    "created_at": "2024-09-24T14:16:06.795Z",
    "last_posted_at": "2024-10-09T15:07:14.151Z",
    "views": 260,
    "like_count": 2,
    "reply_count": 6,
    "has_accepted_answer": true,
    "accepted_answer_post_number": 8,
    "accepted_answer_username": "Andrew",
    "tags": [
      "layout"
    ],
    "category_id": 5,
    "participant_count": 2,
    "word_count": 1349
  },
  "posts": [
    {
      "id": 2463,
      "post_number": 1,
      "username": "sijo",
      "name": "",
      "created_at": "2024-09-24T14:16:06.993Z",
      "updated_at": "2024-09-24T14:16:06.993Z",
      "cooked": "<p>I want to offer two functions:</p>\n<ul>\n<li><code>floating(it)</code>: places <code>it</code> as a floating element at the top of the page (plus some other stuff irrelevant to this question)</li>\n<li><code>tall-box(it)</code>: wraps <code>it</code> in a box that uses the full height, minus the height of the floating element if present</li>\n</ul>\n<p>My idea was to have <code>floating</code> add metadata with the float height, and have <code>tall-box</code> retrieve the metadata to size the box correctly.</p>\n<p>But that doesn’t seem to work:</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">#set page(width: 8cm, height: 6cm, margin: 1cm)\n\n#let float-label() = label(\"float\" + str(here().page()))\n\n#let floating(it) = context {\n  let height = measure(it).height\n  let new-it = [#it #metadata(height) #float-label()]\n  place(top, float: true, clearance: 0pt, new-it)\n}\n\n#let tall-box(color, it) = context {\n  let floats = query(float-label())\n  let float-h = if floats.len() == 0 { 0pt } else { floats.first().value }\n  context box(fill: color, height: 100% - float-h, it)\n}\n\n#set align(horizon)\n\n// page with tall box using the full height\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n\n#pagebreak(weak: true)\n\n// page with blue float, and tall box using remaining height\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n</code></pre>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://forum.typst.app/uploads/default/original/1X/ad5c6e51996a5c345e0f88a89e486b93cddb0812.png\" data-download-href=\"https://forum.typst.app/uploads/default/ad5c6e51996a5c345e0f88a89e486b93cddb0812\" title=\"image\"><img src=\"https://forum.typst.app/uploads/default/optimized/1X/ad5c6e51996a5c345e0f88a89e486b93cddb0812_2_223x500.png\" alt=\"image\" data-base62-sha1=\"oJCDlY61XNeK8st9XJE4Jdwyhhw\" width=\"223\" height=\"500\" srcset=\"https://forum.typst.app/uploads/default/optimized/1X/ad5c6e51996a5c345e0f88a89e486b93cddb0812_2_223x500.png, https://forum.typst.app/uploads/default/original/1X/ad5c6e51996a5c345e0f88a89e486b93cddb0812.png 1.5x, https://forum.typst.app/uploads/default/original/1X/ad5c6e51996a5c345e0f88a89e486b93cddb0812.png 2x\" data-dominant-color=\"E1E8E1\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">305×682 8.38 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>The tall box gets pushed to a third page. I guess on the first iteration the float is not found so the tall box is sized too high, then the float is placed and the tall box is pushed to the next page. How can I avoid that?</p>\n<p>Weirdly it seems to work if I put the <code>#floating</code> line last:</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">...\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n</code></pre>\n<p><img src=\"https://forum.typst.app/uploads/default/original/1X/d66bd7a5d8dda8d973daf7db9fa446b83b773a40.png\" alt=\"image\" data-base62-sha1=\"uARefJ2d9XT5lBBo1ugMvC1i3jq\" width=\"225\" height=\"339\"></p>\n<p>but in my application <code>floating</code> will usually be called first so I can’t rely on that.</p>",
      "raw": "I want to offer two functions:\n\n* `floating(it)`: places `it` as a floating element at the top of the page (plus some other stuff irrelevant to this question)\n* `tall-box(it)`: wraps `it` in a box that uses the full height, minus the height of the floating element if present\n\nMy idea was to have `floating` add metadata with the float height, and have `tall-box` retrieve the metadata to size the box correctly.\n\nBut that doesn't seem to work:\n\n```typ\n#set page(width: 8cm, height: 6cm, margin: 1cm)\n\n#let float-label() = label(\"float\" + str(here().page()))\n\n#let floating(it) = context {\n  let height = measure(it).height\n  let new-it = [#it #metadata(height) #float-label()]\n  place(top, float: true, clearance: 0pt, new-it)\n}\n\n#let tall-box(color, it) = context {\n  let floats = query(float-label())\n  let float-h = if floats.len() == 0 { 0pt } else { floats.first().value }\n  context box(fill: color, height: 100% - float-h, it)\n}\n\n#set align(horizon)\n\n// page with tall box using the full height\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n\n#pagebreak(weak: true)\n\n// page with blue float, and tall box using remaining height\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n```\n\n![image|223x500, 100%](upload://oJCDlY61XNeK8st9XJE4Jdwyhhw.png)\n\nThe tall box gets pushed to a third page. I guess on the first iteration the float is not found so the tall box is sized too high, then the float is placed and the tall box is pushed to the next page. How can I avoid that?\n\nWeirdly it seems to work if I put the `#floating` line last:\n\n```typ\n...\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n```\n\n![image|301x453, 75%](upload://uARefJ2d9XT5lBBo1ugMvC1i3jq.png)\n\nbut in my application `floating` will usually be called first so I can't rely on that.",
      "reply_to_post_number": null,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 0,
      "reads": 55,
      "score": 570.8,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 332
    },
    {
      "id": 2480,
      "post_number": 2,
      "username": "Andrew",
      "name": "",
      "created_at": "2024-09-24T16:51:37.729Z",
      "updated_at": "2024-09-24T16:51:37.729Z",
      "cooked": "<p>When compiling it with 2024-09-09 version, it gives a warning about not being able to converge in 5 tries.</p>\n<p>I think it is because floating figures will be inserted last, after everything else is typeset, and it is clear where it is better to put it. But <code>tall-box</code> depends on the floating position, and it should be placed first. So there is some time-related conflict.</p>\n<p>I don’t really know how adding float last fixes this, but it somehow does. Either there is some hidden behavior that I don’t know, or it’s some sort of bug.</p>\n<p>The solution is very clever, and I personally don’t know how to change it.</p>\n<aside class=\"quote no-group\" data-username=\"sijo\" data-post=\"1\" data-topic=\"639\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/letter_avatar_proxy/v4/letter/s/0A3649/48.png\" class=\"avatar\"> sijo:</div>\n<blockquote>\n<p>but in my application <code>floating</code> will usually be called first so I can’t rely on that.</p>\n</blockquote>\n</aside>\n<p>I assume that this is because it places some other stuff at the top too?</p>",
      "raw": "When compiling it with 2024-09-09 version, it gives a warning about not being able to converge in 5 tries.\n\nI think it is because floating figures will be inserted last, after everything else is typeset, and it is clear where it is better to put it. But `tall-box` depends on the floating position, and it should be placed first. So there is some time-related conflict.\n\nI don't really know how adding float last fixes this, but it somehow does. Either there is some hidden behavior that I don't know, or it's some sort of bug.\n\nThe solution is very clever, and I personally don't know how to change it.\n\n[quote=\"sijo, post:1, topic:639\"]\nbut in my application `floating` will usually be called first so I can’t rely on that.\n[/quote]\n\nI assume that this is because it places some other stuff at the top too?",
      "reply_to_post_number": null,
      "reply_count": 1,
      "quote_count": 1,
      "like_count": 0,
      "reads": 46,
      "score": 19.2,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 51
    },
    {
      "id": 2481,
      "post_number": 3,
      "username": "sijo",
      "name": "",
      "created_at": "2024-09-24T17:00:28.980Z",
      "updated_at": "2024-09-24T17:09:32.995Z",
      "cooked": "<p>Thanks, I just tried with the current main and don’t see any convergence issue so something must have changed recently.</p>\n<p>Regarding what you say about floats being inserted last: at first I thought that cannot be it because here with <code>place(top, float: true, ...)</code> the float position is already given. But maybe the implementation is shared with other types of floats that don’t have fix position, so indeed that could explain it.</p>\n<aside class=\"quote no-group\" data-username=\"Andrew\" data-post=\"2\" data-topic=\"639\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/user_avatar/forum.typst.app/andrew/48/62_2.png\" class=\"avatar\"> Andrew:</div>\n<blockquote>\n<p>I assume that this is because it places some other stuff at the top too?</p>\n</blockquote>\n</aside>\n<p>That can happen, though the typical use for this <code>floating</code> function would be a show rule for some headings, and the red and green boxes correspond to content that the user adds later in the document.</p>\n<p>Edit: thinking more about it, another reason why the float insertion could be delayed is because typst might decide to insert first another float (this one without fixed alignment.</p>",
      "raw": "Thanks, I just tried with the current main and don't see any convergence issue so something must have changed recently.\n\nRegarding what you say about floats being inserted last: at first I thought that cannot be it because here with `place(top, float: true, ...)` the float position is already given. But maybe the implementation is shared with other types of floats that don't have fix position, so indeed that could explain it.\n\n[quote=\"Andrew, post:2, topic:639\"]\nI assume that this is because it places some other stuff at the top too?\n[/quote]\n\nThat can happen, though the typical use for this `floating` function would be a show rule for some headings, and the red and green boxes correspond to content that the user adds later in the document.\n\nEdit: thinking more about it, another reason why the float insertion could be delayed is because typst might decide to insert first another float (this one without fixed alignment.",
      "reply_to_post_number": 2,
      "reply_count": 0,
      "quote_count": 1,
      "like_count": 0,
      "reads": 42,
      "score": 18.4,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 332
    },
    {
      "id": 2501,
      "post_number": 4,
      "username": "Andrew",
      "name": "",
      "created_at": "2024-09-24T22:37:49.165Z",
      "updated_at": "2024-09-24T22:37:49.165Z",
      "cooked": "<p>I’m not 100% sure, but <a class=\"mention\" href=\"/u/laurmaedje\">@laurmaedje</a> is working on <a href=\"https://github.com/typst/typst/pull/5017\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">New flow layout, with multi-column floats by laurmaedje · Pull Request #5017 · typst/typst · GitHub</a>, which <em>might</em> introduce <em>enough</em> changes so that this question can be solved more easily. One of the linked issues might be helpful too: <a href=\"https://github.com/typst/typst/issues/4220\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">Support fraction as block height · Issue #4220 · typst/typst · GitHub</a>.</p>",
      "raw": "I'm not 100% sure, but @laurmaedje is working on https://github.com/typst/typst/pull/5017, which *might* introduce *enough* changes so that this question can be solved more easily. One of the linked issues might be helpful too: https://github.com/typst/typst/issues/4220.",
      "reply_to_post_number": null,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 1,
      "reads": 32,
      "score": 26.4,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 51
    },
    {
      "id": 2602,
      "post_number": 5,
      "username": "sijo",
      "name": "",
      "created_at": "2024-09-25T17:38:16.222Z",
      "updated_at": "2024-09-25T17:38:55.227Z",
      "cooked": "<p>Haha I reported that linked issue :) Indeed now that this awesome PR fixed it I can use <code>block(height: 1fr, ...)</code> which covers the main use case.</p>\n<p>It’s not a complete fix since I also have the red box on the left, so I must get the user to put red and green together in a <code>block(height: 1fr)</code>. It’s also a bit less flexible than what I had in mind: I thought <code>tall-box</code> could have a parameter to make the height only <code>90%</code> or <code>50%</code> or whatever, but <code>height: 1fr</code> will always take the full height.</p>\n<p>Anyway I think this will be good enough for now.</p>",
      "raw": "Haha I reported that linked issue :) Indeed now that this awesome PR fixed it I can use `block(height: 1fr, ...)` which covers the main use case.\n\nIt's not a complete fix since I also have the red box on the left, so I must get the user to put red and green together in a `block(height: 1fr)`. It's also a bit less flexible than what I had in mind: I thought `tall-box` could have a parameter to make the height only `90%` or `50%` or whatever, but `height: 1fr` will always take the full height.\n\nAnyway I think this will be good enough for now.",
      "reply_to_post_number": 4,
      "reply_count": 2,
      "quote_count": 0,
      "like_count": 0,
      "reads": 34,
      "score": 16.8,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 332
    },
    {
      "id": 2606,
      "post_number": 6,
      "username": "Andrew",
      "name": "",
      "created_at": "2024-09-25T18:38:55.375Z",
      "updated_at": "2024-09-25T18:39:14.721Z",
      "cooked": "<p>You can try <code>0.5fr</code>, but I think it won’t make a difference since it’s the only block that has a fraction height.</p>",
      "raw": "You can try `0.5fr`, but I think it won't make a difference since it's the only block that has a fraction height.",
      "reply_to_post_number": 5,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 0,
      "reads": 35,
      "score": 12.0,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 51
    },
    {
      "id": 2640,
      "post_number": 7,
      "username": "sijo",
      "name": "",
      "created_at": "2024-09-26T10:12:24.271Z",
      "updated_at": "2024-09-26T10:12:24.271Z",
      "cooked": "<p>Yeah exactly… Also I’d like to be able to reserve some space on the page for other things above or below, e.g. having a tall-box height of <code>100% - 2cm</code>. I can convert that to the correct height if I know the height of the floating element (though it doesn’t work as discussed above because the floating element is found too late). With a <code>...fr</code> height I cannot reserve space.</p>",
      "raw": "Yeah exactly... Also I'd like to be able to reserve some space on the page for other things above or below, e.g. having a tall-box height of `100% - 2cm`. I can convert that to the correct height if I know the height of the floating element (though it doesn't work as discussed above because the floating element is found too late). With a `...fr` height I cannot reserve space.",
      "reply_to_post_number": 6,
      "reply_count": 1,
      "quote_count": 0,
      "like_count": 0,
      "reads": 34,
      "score": 11.8,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 332
    },
    {
      "id": 3413,
      "post_number": 8,
      "username": "Andrew",
      "name": "",
      "created_at": "2024-10-04T16:39:58.458Z",
      "updated_at": "2024-10-04T16:44:45.441Z",
      "cooked": "<aside class=\"quote no-group\" data-username=\"sijo\" data-post=\"5\" data-topic=\"639\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/letter_avatar_proxy/v4/letter/s/0A3649/48.png\" class=\"avatar\"> sijo:</div>\n<blockquote>\n<p>I thought <code>tall-box</code> could have a parameter to make the height only <code>90%</code> or <code>50%</code> or whatever</p>\n</blockquote>\n</aside>\n<p>Doesn’t this work how you want it?</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">#set page(width: 8cm, height: 6cm, margin: 1cm)\n\n#let floating = place.with(top, float: true, clearance: 0pt)\n#let tall-box(color, height: 100%, it) = {\n  box(fill: color, height: height, align(horizon, it))\n}\n\n// page with tall box using the full height\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n\n#pagebreak()\n\n// page with blue float, and tall box using remaining height\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n#block(height: 1fr, {\n  set align(bottom)\n  box(fill: red, inset: 5mm)[User content]\n  tall-box(green, height: 50%)[Tall box]\n})\n</code></pre>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://forum.typst.app/uploads/default/original/1X/3f0d1f2dd6d0071572c9f31147709c0f3edab953.png\" data-download-href=\"https://forum.typst.app/uploads/default/3f0d1f2dd6d0071572c9f31147709c0f3edab953\" title=\"image\"><img src=\"https://forum.typst.app/uploads/default/optimized/1X/3f0d1f2dd6d0071572c9f31147709c0f3edab953_2_332x500.png\" alt=\"image\" data-base62-sha1=\"8ZMc1xQGhi7Ol2okCDJ6L81tTaz\" width=\"332\" height=\"500\" srcset=\"https://forum.typst.app/uploads/default/optimized/1X/3f0d1f2dd6d0071572c9f31147709c0f3edab953_2_332x500.png, https://forum.typst.app/uploads/default/original/1X/3f0d1f2dd6d0071572c9f31147709c0f3edab953.png 1.5x, https://forum.typst.app/uploads/default/original/1X/3f0d1f2dd6d0071572c9f31147709c0f3edab953.png 2x\" data-dominant-color=\"181B15\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">461×694 13.3 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<aside class=\"quote no-group\" data-username=\"sijo\" data-post=\"7\" data-topic=\"639\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://forum.typst.app/letter_avatar_proxy/v4/letter/s/0A3649/48.png\" class=\"avatar\"> sijo:</div>\n<blockquote>\n<p>Also I’d like to be able to reserve some space on the page for other things above or below, e.g. having a tall-box height of <code>100% - 2cm</code>.</p>\n</blockquote>\n</aside>\n<p>Since <code>box.height</code> already supports <a href=\"https://typst.app/docs/reference/layout/relative/\"><code>relative</code></a> type, you can do that.</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">#block(height: 1fr, {\n  set align(bottom)\n  box(fill: red, inset: 5mm)[User content]\n  tall-box(green, height: 100% - 2cm)[Tall box]\n})\n</code></pre>\n<p>There is also <code>v(1fr)</code> that you can integrate somewhere, maybe.</p>",
      "raw": "[quote=\"sijo, post:5, topic:639\"]\nI thought `tall-box` could have a parameter to make the height only `90%` or `50%` or whatever\n[/quote]\n\nDoesn't this work how you want it?\n\n```typ\n#set page(width: 8cm, height: 6cm, margin: 1cm)\n\n#let floating = place.with(top, float: true, clearance: 0pt)\n#let tall-box(color, height: 100%, it) = {\n  box(fill: color, height: height, align(horizon, it))\n}\n\n// page with tall box using the full height\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n\n#pagebreak()\n\n// page with blue float, and tall box using remaining height\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n#block(height: 1fr, {\n  set align(bottom)\n  box(fill: red, inset: 5mm)[User content]\n  tall-box(green, height: 50%)[Tall box]\n})\n```\n\n![image|332x500](upload://8ZMc1xQGhi7Ol2okCDJ6L81tTaz.png)\n\n[quote=\"sijo, post:7, topic:639\"]\nAlso I’d like to be able to reserve some space on the page for other things above or below, e.g. having a tall-box height of `100% - 2cm`.\n[/quote]\n\nSince `box.height` already supports [`relative`](https://typst.app/docs/reference/layout/relative/) type, you can do that.\n\n```typ\n#block(height: 1fr, {\n  set align(bottom)\n  box(fill: red, inset: 5mm)[User content]\n  tall-box(green, height: 100% - 2cm)[Tall box]\n})\n```\n\nThere is also `v(1fr)` that you can integrate somewhere, maybe.",
      "reply_to_post_number": 5,
      "reply_count": 1,
      "quote_count": 2,
      "like_count": 1,
      "reads": 34,
      "score": 66.8,
      "accepted_answer": true,
      "trust_level": 3,
      "user_id": 51
    },
    {
      "id": 3526,
      "post_number": 9,
      "username": "sijo",
      "name": "",
      "created_at": "2024-10-07T13:06:11.135Z",
      "updated_at": "2024-10-07T13:06:50.960Z",
      "cooked": "<p>Yes that works! I got to the same solution :) The downside is that I must ask the user to add this <code>block(height: 1fr, it)</code> wrapper themselves. I was hoping I could get <code>floating</code> and <code>tall-box</code> to just work. For now I’ll add the <code>block</code> wrapper method to the documentation.</p>",
      "raw": "Yes that works! I got to the same solution :) The downside is that I must ask the user to add this `block(height: 1fr, it)` wrapper themselves. I was hoping I could get `floating` and `tall-box` to just work. For now I'll add the `block` wrapper method to the documentation.",
      "reply_to_post_number": 8,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 0,
      "reads": 21,
      "score": 9.2,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 332
    },
    {
      "id": 3617,
      "post_number": 10,
      "username": "sijo",
      "name": "",
      "created_at": "2024-10-09T15:07:14.151Z",
      "updated_at": "2024-10-09T15:07:14.151Z",
      "cooked": "<p>So I finally found a solution that checks all the boxes, though I’m not sure how much I can rely on it working with future typst versions:</p>\n<pre data-code-wrap=\"typ\"><code class=\"lang-typ\">#set page(width: 8cm, height: 6cm, margin: 1cm)\n\n#let float-label(page) = label(\"float\" + str(page))\n\n#let floating(it) = context {\n  let height = measure(it).height\n  let new-it = [#it #metadata(height) #float-label(here().page())]\n  place(top, float: true, clearance: 0pt, new-it)\n}\n\n#let tall-box(color, it) = {\n  context [#metadata((page: here().page()))&lt;tall-box-pos&gt;]\n  context {\n    let md = query(selector(&lt;tall-box-pos&gt;).before(here())).last()\n    let floats = query(float-label(md.value.page))\n    let float-h = if floats.len() == 0 { 0pt } else { floats.first().value }\n    context box(fill: color, height: 100% - float-h, it)\n  }\n}\n\n#set align(horizon)\n\n// page with tall box using the full height\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n#pagebreak(weak: true)\n\n// page with blue float, and tall box using remaining height\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n</code></pre>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://forum.typst.app/uploads/default/original/1X/346b4cb366e40f91a11d725bfefe91e41af64123.png\" data-download-href=\"https://forum.typst.app/uploads/default/346b4cb366e40f91a11d725bfefe91e41af64123\" title=\"image\"><img src=\"https://forum.typst.app/uploads/default/optimized/1X/346b4cb366e40f91a11d725bfefe91e41af64123_2_250x375.png\" alt=\"image\" data-base62-sha1=\"7tIIrsWBuG5fgMw4k2VHevKt587\" width=\"250\" height=\"375\" srcset=\"https://forum.typst.app/uploads/default/optimized/1X/346b4cb366e40f91a11d725bfefe91e41af64123_2_250x375.png, https://forum.typst.app/uploads/default/original/1X/346b4cb366e40f91a11d725bfefe91e41af64123.png 1.5x, https://forum.typst.app/uploads/default/original/1X/346b4cb366e40f91a11d725bfefe91e41af64123.png 2x\" data-dominant-color=\"D6DDD4\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">349×521 8.51 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>",
      "raw": "So I finally found a solution that checks all the boxes, though I'm not sure how much I can rely on it working with future typst versions:\n\n```typ\n#set page(width: 8cm, height: 6cm, margin: 1cm)\n\n#let float-label(page) = label(\"float\" + str(page))\n\n#let floating(it) = context {\n  let height = measure(it).height\n  let new-it = [#it #metadata(height) #float-label(here().page())]\n  place(top, float: true, clearance: 0pt, new-it)\n}\n\n#let tall-box(color, it) = {\n  context [#metadata((page: here().page()))<tall-box-pos>]\n  context {\n    let md = query(selector(<tall-box-pos>).before(here())).last()\n    let floats = query(float-label(md.value.page))\n    let float-h = if floats.len() == 0 { 0pt } else { floats.first().value }\n    context box(fill: color, height: 100% - float-h, it)\n  }\n}\n\n#set align(horizon)\n\n// page with tall box using the full height\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n#pagebreak(weak: true)\n\n// page with blue float, and tall box using remaining height\n#floating(box(fill: blue, inset: 5mm, [Floating element]))\n#box(fill: red, inset: 5mm)[User content]\n#tall-box(green)[Tall box]\n```\n\n![image|334x500, 75%](upload://7tIIrsWBuG5fgMw4k2VHevKt587.png)",
      "reply_to_post_number": null,
      "reply_count": 0,
      "quote_count": 0,
      "like_count": 0,
      "reads": 20,
      "score": 4.0,
      "accepted_answer": false,
      "trust_level": 3,
      "user_id": 332
    }
  ],
  "scraped_at": "2025-06-10T09:58:12.735354"
}